# 🎙️ run.sh 使用指南

## 快速開始

```bash
cd "/Users/chenliangyu/Desktop/story telling podcast"
./run.sh
```

首次執行會出現新的主選單，將常用維運功能集中在一起：

```
====== Storytelling 工具 ======
1) 啟動互動式 CLI
2) 查看 / 改名書籍
3) 手動同步 output → GCS
4) 離開
```

- 選擇 `1` 會進入原本的 Storytelling CLI 主畫面（流程不變）。
- 選擇 `2` 會先列出所有書籍，確認後若輸入 `y` 才會呼叫 `scripts/rename_book.py` 進行改名，完成後重新顯示最新列表。
- 選擇 `3` 可以在不重新進 CLI 的情況下手動觸發一次 GCS 同步（排除 `.wav` 與隱藏檔）。
- 選擇 `4` 或 `q` 會結束腳本。
- `run.sh` 接受原本的參數模式：如果帶入 `delete` 或其他 CLI 參數，會直接執行 Storytelling CLI 而不顯示選單。

---

## 界面說明

### 主界面

```
╔══════════════════════════════════════════════════════════════════════════╗
║         🎙️  Storytelling Podcast - Foundation 專案管理               ║
╚══════════════════════════════════════════════════════════════════════════╝

📚 書本：Foundation
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

編號 章節                    腳本狀態                 音頻狀態
────────────────────────────────────────────────────────────────────
1)   📖 chapter0             📝 已生成               🎵 已生成
2)   📖 chapter1             📝 已生成               ❌ 無
3)   📖 chapter2             ❌ 無                   ❌ 無

📊 統計資訊
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  總章節數: 3
  已有腳本: 2 / 3
  已有音頻: 1 / 3
  完整章節: 1 / 3 (腳本+音頻)
```

---

## 功能選單

### 📝 腳本生成

#### 1) 為指定章節生成腳本

**使用場景**：為單一章節生成腳本

**操作流程**：
1. 輸入 `1`
2. 選擇章節編號（例如：`1` 代表 chapter0）
3. 系統自動檢查 `data/foundation/chapter0.txt` 是否存在
4. 調用 `storytelling_generate_script.py` 生成腳本
5. 輸出到 `output/foundation/chapter0/podcast_script.txt`

**前置條件**：
- 必須存在源文件：`data/foundation/{章節名稱}.txt`

---

#### 2) 批次生成所有腳本

**使用場景**：一次性為所有章節生成腳本

**操作流程**：
1. 輸入 `2`
2. 系統自動掃描 `data/foundation/` 目錄
3. 列出所有 `.txt` 文件
4. 確認後逐個生成腳本
5. 顯示成功/失敗統計

**範例輸出**：
```
📚 批次生成腳本
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

找到 3 個源文件：
  📖 chapter0
  📖 chapter1
  📖 chapter2

是否繼續批次生成？ (y/n):
```

---

### 🎵 音頻生成

#### 3) 為指定章節生成音頻

**使用場景**：為已有腳本的單一章節生成音頻

**操作流程**：
1. 輸入 `3`
2. 選擇章節編號
3. 系統自動檢查是否有腳本
4. 若無腳本，顯示錯誤並提示先生成腳本
5. 若有腳本，調用 `storytelling_generate_audio.py` 生成音頻
6. 輸出到 `output/foundation/{章節}/podcast.wav`

**限制條件**：
- ⚠️ **必須先有腳本才能生成音頻**
- 如果選擇無腳本的章節，會顯示錯誤訊息：

```
❌ 無法生成音頻：chapter2 尚未生成腳本
⚠️  請先執行「生成腳本」選項
```

---

#### 4) 批次生成所有音頻

**使用場景**：一次性為所有有腳本的章節生成音頻

**操作流程**：
1. 輸入 `4`
2. 系統自動掃描所有章節
3. **智能篩選**：只列出有腳本但沒有音頻的章節
4. 確認後逐個生成音頻
5. 顯示成功/失敗統計

**範例輸出**：
```
🎵 批次生成音頻
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

找到 1 個可生成音頻的章節：
  📖 chapter1

是否繼續批次生成音頻？ (y/n):
```

**自動跳過**：
- 沒有腳本的章節（自動忽略）
- 已經有音頻的章節（自動忽略）

---

### 🛠️ 工具功能

#### 5) 測試 API 連線

**功能**：測試 Gemini API 是否正常連接

```bash
python test_api.py
```

---

#### 6) 查看配置說明

**顯示資訊**：
- 配置文件位置
- 資料目錄
- 輸出目錄
- 書籍名稱

---

#### 7) 刷新顯示

**功能**：重新掃描章節狀態並更新顯示

**使用場景**：
- 手動添加/刪除了章節文件
- 想要查看最新狀態

---

#### 0) 退出

**功能**：退出程式

---

## 工作流程建議

### 場景 1：新增單一章節

```
1. 準備源文件：data/foundation/chapter3.txt
2. 運行 ./run.sh
3. 選擇 [1] 為指定章節生成腳本
4. 選擇章節編號 (例如：3)
5. 等待腳本生成完成
6. 選擇 [3] 為指定章節生成音頻
7. 選擇章節編號 (例如：3)
8. 等待音頻生成完成
```

---

### 場景 2：批次處理所有章節

```
1. 準備所有源文件：data/foundation/chapter*.txt
2. 運行 ./run.sh
3. 選擇 [2] 批次生成所有腳本
4. 確認生成
5. 等待完成
6. 選擇 [4] 批次生成所有音頻
7. 確認生成
8. 等待完成
```

---

### 場景 3：只為部分章節生成音頻

```
1. 運行 ./run.sh
2. 查看主界面的章節狀態列表
3. 選擇 [3] 為指定章節生成音頻
4. 逐個選擇需要生成音頻的章節
5. 每次操作完成後，按 Enter 返回主選單
6. 重複步驟 3-5，直到完成所有需要的章節
```

---

## 目錄結構

### 輸入（源文件）

```
data/foundation/
├── chapter0.txt
├── chapter1.txt
├── chapter2.txt
└── ...
```

### 輸出（生成結果）

```
output/foundation/
├── chapter0/
│   ├── podcast_script.txt   ← 腳本
│   ├── podcast.wav          ← 音頻
│   └── metadata.json        ← 元數據
├── chapter1/
│   ├── podcast_script.txt
│   └── metadata.json
└── ...
```

---

## 狀態圖標說明

| 圖標 | 說明 |
|------|------|
| 📝 已生成 | 腳本文件存在 |
| 🎵 已生成 | 音頻文件存在 (.wav 或 .mp3) |
| ❌ 無 | 文件不存在 |
| ✅ | 操作成功 |
| ⚠️ | 警告訊息 |
| 📚 | 書本 |
| 📖 | 章節 |

---

## 錯誤處理

### 常見錯誤 1：源文件不存在

```
❌ 源文件不存在: data/foundation/chapter3.txt
⚠️  請確保在 data/foundation/ 目錄下有 chapter3.txt 文件
```

**解決方法**：
1. 檢查文件名是否正確
2. 確保文件存在於 `data/foundation/` 目錄

---

### 常見錯誤 2：嘗試為無腳本章節生成音頻

```
❌ 無法生成音頻：chapter2 尚未生成腳本
⚠️  請先執行「生成腳本」選項
```

**解決方法**：
1. 先選擇 [1] 或 [2] 生成腳本
2. 再選擇 [3] 或 [4] 生成音頻

---

### 常見錯誤 3：API 連接失敗

**解決方法**：
1. 選擇 [5] 測試 API 連線
2. 檢查 `.env` 文件中的 `GEMINI_API_KEY`
3. 檢查網路連接

---

## 高級功能

### 循環式操作

新的 run.sh 採用**循環式設計**：
- 每次操作完成後自動返回主選單
- 無需重新啟動程式
- 可連續處理多個章節
- 選擇 [7] 刷新顯示以查看最新狀態

---

### 批次操作的優勢

1. **智能篩選**：
   - 批次腳本生成：自動掃描所有源文件
   - 批次音頻生成：只處理有腳本但沒有音頻的章節

2. **錯誤容錯**：
   - 單一章節失敗不會中斷整個批次
   - 顯示詳細的成功/失敗統計

3. **進度可見**：
   - 顯示當前正在處理的章節
   - 實時輸出生成進度

---

## 提示與技巧

### 提示 1：使用刷新功能

如果你在另一個終端機手動添加了文件，選擇 [7] 刷新顯示來更新狀態列表。

---

### 提示 2：批次操作前先檢查

在執行批次操作前，先查看主界面的統計資訊，確認有多少章節需要處理。

---

### 提示 3：分階段處理

對於大量章節，建議分階段處理：
1. 第一階段：批次生成所有腳本
2. 檢查腳本質量
3. 第二階段：批次生成所有音頻

---

## 與舊版本的差異

| 功能 | 舊版 run.sh | 新版 run.sh |
|------|-------------|-------------|
| 章節狀態顯示 | ❌ 無 | ✅ 即時顯示 |
| 批次操作 | ❌ 不支援 | ✅ 支援 |
| 循環式介面 | ❌ 單次執行 | ✅ 循環選單 |
| 智能限制 | ❌ 無 | ✅ 無腳本禁止生成音頻 |
| 統計資訊 | ❌ 無 | ✅ 即時統計 |
| 目錄結構 | 舊架構（時間戳記） | 新架構（書本/章節） |

---

## 故障排除

如果遇到問題，請依序檢查：

1. **確認目錄結構**：
   ```bash
   ls -la data/foundation/
   ls -la output/foundation/
   ```

2. **確認 Python 腳本存在**：
   ```bash
   ls -la storytelling_generate_script.py
   ls -la storytelling_generate_audio.py
   ```

3. **測試 API 連接**：
   - 在 run.sh 中選擇 [5]

4. **檢查日誌**：
   - 查看終端機輸出的錯誤訊息

---

## 總結

新的 run.sh 提供了：
- ✅ **直觀的視覺化介面**：一眼看清所有章節狀態
- ✅ **智能限制**：防止錯誤操作
- ✅ **批次處理**：提高工作效率
- ✅ **循環式設計**：無需重複啟動
- ✅ **友善的用戶體驗**：清晰的提示和錯誤訊息

享受新的工作流程！🎉
